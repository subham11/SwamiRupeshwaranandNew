version: 1
applications:
  - appRoot: frontend
    frontend:
      phases:
        preBuild:
          commands:
            - npm install
            # Clear any cached build artifacts
            - rm -rf .next
        build:
          commands:
            # Set environment variables for production build
            - export NEXT_PUBLIC_API_URL=https://n4vi400a5e.execute-api.ap-south-1.amazonaws.com/prod
            - export NEXT_PUBLIC_USE_API=true
            - export AMPLIFY_BUILD=true
            # CMS ISR revalidation: 300s (launch phase), bump to 3600 once content is stable
            - export NEXT_PUBLIC_CMS_REVALIDATE_SECONDS=300
            # Build the Next.js application
            - npm run build
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*

# Note: For SSR to work correctly on Amplify Gen 2, ensure:
# 1. "output" in next.config.ts is NOT set to 'export'
# 2. Framework detection in Amplify Console is set to "Next.js SSR"
# 3. Redirects are configured in Amplify Console > App settings > Rewrites and redirects

# Add this redirect in Amplify Console:
# Source: /
# Target: /en  
# Type: 302 (Redirect - Temporary)
