# Serverless Framework Configuration
# Optimized for AWS Free Tier and Cost Efficiency

service: swami-rupeshwaranand-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'ap-south-1'}
  
  # Cost Optimization: Use ARM64 for better price-performance
  architecture: arm64
  
  # Increased memory for faster cold starts with MongoDB connection
  memorySize: 512
  
  # Increased timeout for cold start with MongoDB connection
  timeout: 30
  
  # Cost Optimization: Enable provisioned concurrency only for prod critical paths
  # For dev/local, keep it disabled
  
  # API Gateway Configuration (Free Tier: 1M API calls/month for 12 months)
  apiGateway:
    shouldStartNameWithService: true
    minimumCompressionSize: 1024
    binaryMediaTypes:
      - '*/*'
  
  environment:
    NODE_ENV: ${self:provider.stage}
    STAGE: ${self:provider.stage}
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
    USE_DYNAMODB: 'true'
    DYNAMODB_TABLE_PREFIX: ${self:service}-${self:provider.stage}
    COGNITO_USER_POOL_ID: ${env:COGNITO_USER_POOL_ID, ''}
    COGNITO_CLIENT_ID: ${env:COGNITO_CLIENT_ID, ''}
    COGNITO_REGION: ${self:provider.region}
  
  # IAM Role for Lambda
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchGetItem
            - dynamodb:BatchWriteItem
          Resource:
            - !GetAtt MainTable.Arn
            - !Join ['/', [!GetAtt MainTable.Arn, 'index/*']]
        - Effect: Allow
          Action:
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminDeleteUser
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminUpdateUserAttributes
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:AdminRespondToAuthChallenge
          Resource: '*'
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'

plugins:
  - serverless-offline
  - serverless-plugin-warmup

custom:
  # Serverless Offline Configuration (Local Development)
  serverless-offline:
    httpPort: 3001
    lambdaPort: 3002
    noPrependStageInUrl: true
    reloadHandler: true
  
  # Warmup Configuration (Cost Optimization: Only warm critical paths in prod)
  warmup:
    default:
      enabled: ${self:provider.stage, 'prod'}
      prewarm: true
      events:
        - schedule: rate(5 minutes)
      concurrency: 1
      memorySize: 128
      timeout: 10

functions:
  # Single Lambda for all routes (Cost Optimization: Reduces cold starts)
  api:
    handler: dist/lambda.handler
    events:
      - http:
          method: ANY
          path: /
          cors: true
      - http:
          method: ANY
          path: '{proxy+}'
          cors: true
    # Cost Optimization: Reserved concurrency removed to stay within account limits
    # reservedConcurrency: 10

resources:
  Resources:
    # DynamoDB Table (Free Tier: 25 GB storage, 25 RCU, 25 WCU)
    MainTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-main
        BillingMode: PAY_PER_REQUEST  # Cost Optimization: On-demand for unpredictable workloads
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        # Cost Optimization: Enable TTL to auto-delete old data
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        # Cost Optimization: Point-in-time recovery disabled for dev
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: false
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: ${self:service}

    # Cognito User Pool (Free Tier: 50,000 MAU)
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Condition: CreateCognitoResources
      Properties:
        UserPoolName: ${self:service}-${self:provider.stage}-user-pool
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        MfaConfiguration: 'OFF'  # Cost Optimization: MFA disabled for free tier
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: true
        Schema:
          - AttributeDataType: String
            Name: email
            Required: true
            Mutable: true
          - AttributeDataType: String
            Name: name
            Required: false
            Mutable: true

    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Condition: CreateCognitoResources
      Properties:
        ClientName: ${self:service}-${self:provider.stage}-client
        UserPoolId: !Ref CognitoUserPool
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_ADMIN_USER_PASSWORD_AUTH
        GenerateSecret: false
        PreventUserExistenceErrors: ENABLED

  Conditions:
    CreateCognitoResources:
      !Equals ['${self:provider.stage}', 'prod']

  Outputs:
    ApiGatewayRestApiId:
      Value: !Ref ApiGatewayRestApi
    MainTableName:
      Value: !Ref MainTable
    MainTableArn:
      Value: !GetAtt MainTable.Arn
    CognitoUserPoolId:
      Condition: CreateCognitoResources
      Value: !Ref CognitoUserPool
    CognitoUserPoolClientId:
      Condition: CreateCognitoResources
      Value: !Ref CognitoUserPoolClient
