# Serverless Framework Configuration
# AWS Cognito-based Auth with OTP (CUSTOM_AUTH) + Password flows

service: swami-rupeshwaranand-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'ap-south-1'}
  profile: ${opt:aws-profile, 'SwamiJi'}
  
  # Cost Optimization: Use ARM64 for better price-performance
  architecture: arm64
  
  # Increased memory for faster cold starts
  memorySize: 512
  
  # Increased timeout for cold start
  timeout: 30
  
  # API Gateway Configuration (Free Tier: 1M API calls/month for 12 months)
  apiGateway:
    shouldStartNameWithService: true
    minimumCompressionSize: 1024
    binaryMediaTypes:
      - '*/*'
  
  environment:
    NODE_ENV: ${self:provider.stage}
    STAGE: ${self:provider.stage}
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
    USE_DYNAMODB: 'true'
    DYNAMODB_TABLE_PREFIX: ${self:service}-${self:provider.stage}
    MAIN_TABLE: !Ref MainTable
    COGNITO_REGION: ${self:provider.region}
    AWS_S3_BUCKET: !Ref ContentBucket
    # Razorpay (from SSM Parameter Store - SecureString)
    RAZORPAY_KEY_ID: ${ssm:/swami-rupeshwaranand/${self:provider.stage}/razorpay-key-id}
    RAZORPAY_KEY_SECRET: ${ssm:/swami-rupeshwaranand/${self:provider.stage}/razorpay-key-secret}
    RAZORPAY_WEBHOOK_SECRET: ${ssm:/swami-rupeshwaranand/${self:provider.stage}/razorpay-webhook-secret}
    # SMTP Email Configuration
    SMTP_HOST: mail.swamirupeshwaranand.in
    SMTP_PORT: '587'
    SMTP_USERNAME: noreply@swamirupeshwaranand.in
    SMTP_PASSWORD: ${ssm:/swami-rupeshwaranand/${self:provider.stage}/smtp-password}
    SMTP_FROM_EMAIL: noreply@swamirupeshwaranand.in
    SMTP_FROM_NAME: Swami Rupeshwaranand ji
  
  # IAM Role for Lambda
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchGetItem
            - dynamodb:BatchWriteItem
          Resource:
            - !GetAtt MainTable.Arn
            - !Join ['/', [!GetAtt MainTable.Arn, 'index/*']]
            - !GetAtt OtpTable.Arn
        - Effect: Allow
          Action:
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminDeleteUser
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminUpdateUserAttributes
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:AdminRespondToAuthChallenge
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:InitiateAuth
            - cognito-idp:RespondToAuthChallenge
          Resource: '*'
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: '*'
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - !Join
              - ''
              - - 'arn:aws:lambda:'
                - !Ref 'AWS::Region'
                - ':'
                - !Ref 'AWS::AccountId'
                - ':function:${self:service}-${self:provider.stage}-sendOtpEmail'
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource:
            - !Join
              - ''
              - - 'arn:aws:ssm:'
                - !Ref 'AWS::Region'
                - ':'
                - !Ref 'AWS::AccountId'
                - ':parameter/swami-rupeshwaranand/*'
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:ListBucket
            - s3:HeadObject
          Resource:
            - !GetAtt ContentBucket.Arn
            - !Join ['/', [!GetAtt ContentBucket.Arn, '*']]

plugins:
  - serverless-offline
  - serverless-plugin-warmup

custom:
  # Serverless Offline Configuration (Local Development)
  serverless-offline:
    httpPort: 3001
    lambdaPort: 3002
    noPrependStageInUrl: true
    reloadHandler: true
  
  # Warmup Configuration (Cost Optimization: Only warm critical paths in prod)
  warmup:
    default:
      enabled: ${self:provider.stage, 'prod'}
      prewarm: true
      events:
        - schedule: rate(15 minutes)
      concurrency: 1
      memorySize: 128
      timeout: 10

functions:
  # Single Lambda for all routes (Cost Optimization: Reduces cold starts)
  api:
    handler: dist/lambda.handler
    environment:
      COGNITO_USER_POOL_ID: !Ref CognitoUserPool
      COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient
    events:
      - http:
          method: ANY
          path: /
          cors: true
      - http:
          method: ANY
          path: '{proxy+}'
          cors: true

  # ─── Cognito Lambda Triggers ───────────────────────────────

  defineAuthChallenge:
    handler: dist/cognito-triggers/define-auth-challenge.handler
    memorySize: 128
    timeout: 5

  createAuthChallenge:
    handler: dist/cognito-triggers/create-auth-challenge.handler
    memorySize: 128
    timeout: 5
    environment:
      OTP_TABLE: !Ref OtpTable
      SEND_OTP_EMAIL_FUNCTION: !Ref SendOtpEmailLambdaFunction

  sendOtpEmail:
    handler: dist/cognito-triggers/send-otp-email.handler
    memorySize: 128
    timeout: 30
    environment:
      SMTP_HOST: ${env:SMTP_HOST, 'mail.swamirupeshwaranand.in'}
      SMTP_PORT: ${env:SMTP_PORT, '587'}
      SMTP_USERNAME: ${env:SMTP_USERNAME, 'noreply@swamirupeshwaranand.in'}
      SMTP_PASSWORD: ${env:SMTP_PASSWORD, ''}
      SMTP_FROM_EMAIL: ${env:SMTP_FROM_EMAIL, 'noreply@swamirupeshwaranand.in'}
      SMTP_FROM_NAME: ${env:SMTP_FROM_NAME, 'Swami Rupeshwaranand ji'}

  verifyAuthChallenge:
    handler: dist/cognito-triggers/verify-auth-challenge.handler
    memorySize: 128
    timeout: 5
    environment:
      OTP_TABLE: !Ref OtpTable

  preSignUp:
    handler: dist/cognito-triggers/pre-sign-up.handler
    memorySize: 128
    timeout: 5

  postAuthentication:
    handler: dist/cognito-triggers/post-authentication.handler
    memorySize: 128
    timeout: 10
    environment:
      MAIN_TABLE: !Ref MainTable

resources:
  Resources:
    # ─── DynamoDB: Main Table ────────────────────────────────
    # Cost Optimization: Provisioned capacity with Auto-Scaling
    # Base: 5 RCU / 5 WCU (within AWS always-free tier)
    # Auto-scales up to 50 RCU / 25 WCU for traffic spikes
    MainTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-main
        BillingMode: PROVISIONED
        ProvisionedThroughput:
          ReadCapacityUnits: 5
          WriteCapacityUnits: 5
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
          - AttributeName: GSI2PK
            AttributeType: S
          - AttributeName: GSI2SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput:
              ReadCapacityUnits: 5
              WriteCapacityUnits: 5
          - IndexName: GSI2
            KeySchema:
              - AttributeName: GSI2PK
                KeyType: HASH
              - AttributeName: GSI2SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput:
              ReadCapacityUnits: 5
              WriteCapacityUnits: 5
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: false
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: ${self:service}

    # ─── DynamoDB Auto-Scaling: Main Table ───────────────────
    MainTableReadScalableTarget:
      Type: AWS::ApplicationAutoScaling::ScalableTarget
      Properties:
        MaxCapacity: 50
        MinCapacity: 5
        ResourceId: !Sub table/${self:service}-${self:provider.stage}-main
        ScalableDimension: dynamodb:table:ReadCapacityUnits
        ServiceNamespace: dynamodb
      DependsOn: MainTable

    MainTableWriteScalableTarget:
      Type: AWS::ApplicationAutoScaling::ScalableTarget
      Properties:
        MaxCapacity: 25
        MinCapacity: 5
        ResourceId: !Sub table/${self:service}-${self:provider.stage}-main
        ScalableDimension: dynamodb:table:WriteCapacityUnits
        ServiceNamespace: dynamodb
      DependsOn: MainTable

    MainTableReadScalingPolicy:
      Type: AWS::ApplicationAutoScaling::ScalingPolicy
      Properties:
        PolicyName: MainTableReadAutoScaling
        PolicyType: TargetTrackingScaling
        ScalingTargetId: !Ref MainTableReadScalableTarget
        TargetTrackingScalingPolicyConfiguration:
          PredefinedMetricSpecification:
            PredefinedMetricType: DynamoDBReadCapacityUtilization
          TargetValue: 70
          ScaleInCooldown: 60
          ScaleOutCooldown: 60

    MainTableWriteScalingPolicy:
      Type: AWS::ApplicationAutoScaling::ScalingPolicy
      Properties:
        PolicyName: MainTableWriteAutoScaling
        PolicyType: TargetTrackingScaling
        ScalingTargetId: !Ref MainTableWriteScalableTarget
        TargetTrackingScalingPolicyConfiguration:
          PredefinedMetricSpecification:
            PredefinedMetricType: DynamoDBWriteCapacityUtilization
          TargetValue: 70
          ScaleInCooldown: 60
          ScaleOutCooldown: 60

    # GSI1 Auto-Scaling
    MainTableGSI1ReadScalableTarget:
      Type: AWS::ApplicationAutoScaling::ScalableTarget
      Properties:
        MaxCapacity: 50
        MinCapacity: 5
        ResourceId: !Sub table/${self:service}-${self:provider.stage}-main/index/GSI1
        ScalableDimension: dynamodb:index:ReadCapacityUnits
        ServiceNamespace: dynamodb
      DependsOn: MainTable

    MainTableGSI1ReadScalingPolicy:
      Type: AWS::ApplicationAutoScaling::ScalingPolicy
      Properties:
        PolicyName: MainTableGSI1ReadAutoScaling
        PolicyType: TargetTrackingScaling
        ScalingTargetId: !Ref MainTableGSI1ReadScalableTarget
        TargetTrackingScalingPolicyConfiguration:
          PredefinedMetricSpecification:
            PredefinedMetricType: DynamoDBReadCapacityUtilization
          TargetValue: 70
          ScaleInCooldown: 60
          ScaleOutCooldown: 60

    # GSI2 Auto-Scaling
    MainTableGSI2ReadScalableTarget:
      Type: AWS::ApplicationAutoScaling::ScalableTarget
      Properties:
        MaxCapacity: 50
        MinCapacity: 5
        ResourceId: !Sub table/${self:service}-${self:provider.stage}-main/index/GSI2
        ScalableDimension: dynamodb:index:ReadCapacityUnits
        ServiceNamespace: dynamodb
      DependsOn: MainTable

    MainTableGSI2ReadScalingPolicy:
      Type: AWS::ApplicationAutoScaling::ScalingPolicy
      Properties:
        PolicyName: MainTableGSI2ReadAutoScaling
        PolicyType: TargetTrackingScaling
        ScalingTargetId: !Ref MainTableGSI2ReadScalableTarget
        TargetTrackingScalingPolicyConfiguration:
          PredefinedMetricSpecification:
            PredefinedMetricType: DynamoDBReadCapacityUtilization
          TargetValue: 70
          ScaleInCooldown: 60
          ScaleOutCooldown: 60

    # ─── DynamoDB: OTP Tracking Table ────────────────────────
    OtpTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-otp
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: ${self:service}

    # ─── Cognito User Pool ───────────────────────────────────
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-${self:provider.stage}-user-pool
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        MfaConfiguration: 'OFF'
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: true
        Schema:
          - AttributeDataType: String
            Name: email
            Required: true
            Mutable: true
          - AttributeDataType: String
            Name: name
            Required: false
            Mutable: true
        LambdaConfig:
          DefineAuthChallenge: !GetAtt DefineAuthChallengeLambdaFunction.Arn
          CreateAuthChallenge: !GetAtt CreateAuthChallengeLambdaFunction.Arn
          VerifyAuthChallengeResponse: !GetAtt VerifyAuthChallengeLambdaFunction.Arn
          PreSignUp: !GetAtt PreSignUpLambdaFunction.Arn
          PostAuthentication: !GetAtt PostAuthenticationLambdaFunction.Arn

    # Cognito User Pool Client (supports password + OTP flows)
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-${self:provider.stage}-client
        UserPoolId: !Ref CognitoUserPool
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_CUSTOM_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_ADMIN_USER_PASSWORD_AUTH
        GenerateSecret: false
        PreventUserExistenceErrors: ENABLED
        AccessTokenValidity: 1
        IdTokenValidity: 1
        RefreshTokenValidity: 7
        TokenValidityUnits:
          AccessToken: hours
          IdToken: hours
          RefreshToken: days

    # ─── Lambda Invoke Permissions for Cognito ───────────────
    DefineAuthChallengePermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt DefineAuthChallengeLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        Action: lambda:InvokeFunction
        SourceArn: !GetAtt CognitoUserPool.Arn

    CreateAuthChallengePermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt CreateAuthChallengeLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        Action: lambda:InvokeFunction
        SourceArn: !GetAtt CognitoUserPool.Arn

    VerifyAuthChallengePermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt VerifyAuthChallengeLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        Action: lambda:InvokeFunction
        SourceArn: !GetAtt CognitoUserPool.Arn

    PreSignUpPermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt PreSignUpLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        Action: lambda:InvokeFunction
        SourceArn: !GetAtt CognitoUserPool.Arn

    PostAuthenticationPermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt PostAuthenticationLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        Action: lambda:InvokeFunction
        SourceArn: !GetAtt CognitoUserPool.Arn

    # ─── S3: Content Bucket ──────────────────────────────────
    ContentBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-${self:provider.stage}-content
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders:
                - '*'
              AllowedMethods:
                - GET
                - PUT
                - POST
                - HEAD
              AllowedOrigins:
                - '*'
              MaxAge: 3600
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: ${self:service}

    ContentBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref ContentBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal: '*'
              Action: s3:GetObject
              Resource: !Join ['/', [!GetAtt ContentBucket.Arn, '*']]

  Outputs:
    ApiGatewayRestApiId:
      Value: !Ref ApiGatewayRestApi
    MainTableName:
      Value: !Ref MainTable
    MainTableArn:
      Value: !GetAtt MainTable.Arn
    OtpTableName:
      Value: !Ref OtpTable
    CognitoUserPoolId:
      Value: !Ref CognitoUserPool
    CognitoUserPoolClientId:
      Value: !Ref CognitoUserPoolClient
    ContentBucketName:
      Value: !Ref ContentBucket
    ContentBucketArn:
      Value: !GetAtt ContentBucket.Arn
