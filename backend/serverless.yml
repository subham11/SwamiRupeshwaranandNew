# Serverless Framework Configuration
# AWS Cognito-based Auth with OTP (CUSTOM_AUTH) + Password flows

service: swami-rupeshwaranand-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${opt:stage, 'dev'}
  region: ${opt:region, 'ap-south-1'}
  
  # Cost Optimization: Use ARM64 for better price-performance
  architecture: arm64
  
  # Increased memory for faster cold starts
  memorySize: 512
  
  # Increased timeout for cold start
  timeout: 30
  
  # API Gateway Configuration (Free Tier: 1M API calls/month for 12 months)
  apiGateway:
    shouldStartNameWithService: true
    minimumCompressionSize: 1024
    binaryMediaTypes:
      - '*/*'
  
  environment:
    NODE_ENV: ${self:provider.stage}
    STAGE: ${self:provider.stage}
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
    USE_DYNAMODB: 'true'
    DYNAMODB_TABLE_PREFIX: ${self:service}-${self:provider.stage}
    MAIN_TABLE: !Ref MainTable
    COGNITO_REGION: ${self:provider.region}
    AWS_S3_BUCKET: !Ref ContentBucket
  
  # IAM Role for Lambda
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchGetItem
            - dynamodb:BatchWriteItem
          Resource:
            - !GetAtt MainTable.Arn
            - !Join ['/', [!GetAtt MainTable.Arn, 'index/*']]
            - !GetAtt OtpTable.Arn
        - Effect: Allow
          Action:
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminDeleteUser
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminUpdateUserAttributes
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:AdminRespondToAuthChallenge
            - cognito-idp:AdminSetUserPassword
            - cognito-idp:InitiateAuth
            - cognito-idp:RespondToAuthChallenge
          Resource: '*'
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: '*'
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:ListBucket
            - s3:HeadObject
          Resource:
            - !GetAtt ContentBucket.Arn
            - !Join ['/', [!GetAtt ContentBucket.Arn, '*']]

plugins:
  - serverless-offline
  - serverless-plugin-warmup

custom:
  # Serverless Offline Configuration (Local Development)
  serverless-offline:
    httpPort: 3001
    lambdaPort: 3002
    noPrependStageInUrl: true
    reloadHandler: true
  
  # Warmup Configuration (Cost Optimization: Only warm critical paths in prod)
  warmup:
    default:
      enabled: ${self:provider.stage, 'prod'}
      prewarm: true
      events:
        - schedule: rate(5 minutes)
      concurrency: 1
      memorySize: 128
      timeout: 10

functions:
  # Single Lambda for all routes (Cost Optimization: Reduces cold starts)
  api:
    handler: dist/lambda.handler
    environment:
      COGNITO_USER_POOL_ID: !Ref CognitoUserPool
      COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient
    events:
      - http:
          method: ANY
          path: /
          cors: true
      - http:
          method: ANY
          path: '{proxy+}'
          cors: true

  # ─── Cognito Lambda Triggers ───────────────────────────────

  defineAuthChallenge:
    handler: dist/cognito-triggers/define-auth-challenge.handler
    memorySize: 128
    timeout: 5

  createAuthChallenge:
    handler: dist/cognito-triggers/create-auth-challenge.handler
    memorySize: 128
    timeout: 10
    environment:
      OTP_TABLE: !Ref OtpTable
      SES_FROM_EMAIL: ${env:SES_FROM_EMAIL, 'satyam@elevatephysique.com'}
      SES_REGION: ${self:provider.region}

  verifyAuthChallenge:
    handler: dist/cognito-triggers/verify-auth-challenge.handler
    memorySize: 128
    timeout: 5
    environment:
      OTP_TABLE: !Ref OtpTable

  preSignUp:
    handler: dist/cognito-triggers/pre-sign-up.handler
    memorySize: 128
    timeout: 5

  postAuthentication:
    handler: dist/cognito-triggers/post-authentication.handler
    memorySize: 128
    timeout: 10
    environment:
      MAIN_TABLE: !Ref MainTable

resources:
  Resources:
    # ─── DynamoDB: Main Table ────────────────────────────────
    MainTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-main
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: false
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: ${self:service}

    # ─── DynamoDB: OTP Tracking Table ────────────────────────
    OtpTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-otp
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: ${self:service}

    # ─── Cognito User Pool ───────────────────────────────────
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: ${self:service}-${self:provider.stage}-user-pool
        AutoVerifiedAttributes:
          - email
        UsernameAttributes:
          - email
        MfaConfiguration: 'OFF'
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
            RequireUppercase: true
        Schema:
          - AttributeDataType: String
            Name: email
            Required: true
            Mutable: true
          - AttributeDataType: String
            Name: name
            Required: false
            Mutable: true
        LambdaConfig:
          DefineAuthChallenge: !GetAtt DefineAuthChallengeLambdaFunction.Arn
          CreateAuthChallenge: !GetAtt CreateAuthChallengeLambdaFunction.Arn
          VerifyAuthChallengeResponse: !GetAtt VerifyAuthChallengeLambdaFunction.Arn
          PreSignUp: !GetAtt PreSignUpLambdaFunction.Arn
          PostAuthentication: !GetAtt PostAuthenticationLambdaFunction.Arn

    # Cognito User Pool Client (supports password + OTP flows)
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: ${self:service}-${self:provider.stage}-client
        UserPoolId: !Ref CognitoUserPool
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_CUSTOM_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_ADMIN_USER_PASSWORD_AUTH
        GenerateSecret: false
        PreventUserExistenceErrors: ENABLED
        AccessTokenValidity: 1
        IdTokenValidity: 1
        RefreshTokenValidity: 7
        TokenValidityUnits:
          AccessToken: hours
          IdToken: hours
          RefreshToken: days

    # ─── Lambda Invoke Permissions for Cognito ───────────────
    DefineAuthChallengePermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt DefineAuthChallengeLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        Action: lambda:InvokeFunction
        SourceArn: !GetAtt CognitoUserPool.Arn

    CreateAuthChallengePermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt CreateAuthChallengeLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        Action: lambda:InvokeFunction
        SourceArn: !GetAtt CognitoUserPool.Arn

    VerifyAuthChallengePermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt VerifyAuthChallengeLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        Action: lambda:InvokeFunction
        SourceArn: !GetAtt CognitoUserPool.Arn

    PreSignUpPermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt PreSignUpLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        Action: lambda:InvokeFunction
        SourceArn: !GetAtt CognitoUserPool.Arn

    PostAuthenticationPermission:
      Type: AWS::Lambda::Permission
      Properties:
        FunctionName: !GetAtt PostAuthenticationLambdaFunction.Arn
        Principal: cognito-idp.amazonaws.com
        Action: lambda:InvokeFunction
        SourceArn: !GetAtt CognitoUserPool.Arn

    # ─── S3: Content Bucket ──────────────────────────────────
    ContentBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-${self:provider.stage}-content
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders:
                - '*'
              AllowedMethods:
                - GET
                - PUT
                - POST
                - HEAD
              AllowedOrigins:
                - '*'
              MaxAge: 3600
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: ${self:service}

    ContentBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref ContentBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal: '*'
              Action: s3:GetObject
              Resource: !Join ['/', [!GetAtt ContentBucket.Arn, '*']]

  Outputs:
    ApiGatewayRestApiId:
      Value: !Ref ApiGatewayRestApi
    MainTableName:
      Value: !Ref MainTable
    MainTableArn:
      Value: !GetAtt MainTable.Arn
    OtpTableName:
      Value: !Ref OtpTable
    CognitoUserPoolId:
      Value: !Ref CognitoUserPool
    CognitoUserPoolClientId:
      Value: !Ref CognitoUserPoolClient
    ContentBucketName:
      Value: !Ref ContentBucket
    ContentBucketArn:
      Value: !GetAtt ContentBucket.Arn
